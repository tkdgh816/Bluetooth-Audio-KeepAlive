<?xml version="1.0" encoding="utf-8"?>
<Page x:Class="KeepAliveApp.MainPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="using:KeepAliveApp"
      xmlns:settings="using:KeepAliveSettings"
      xmlns:converters="using:KeepAliveApp.Converters"
      xmlns:controls="using:KeepAliveApp.Controls"
      xmlns:toolkit="using:CommunityToolkit.WinUI.Controls">

  <Page.Resources>
    <converters:EnumToIntConverter x:Key="SoundKindToIntConverter"
                                   EnumType="settings:SoundKind" />
  </Page.Resources>

  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition />
    </Grid.RowDefinitions>

    <TextBlock Grid.Row="0"
               Text="Settings"
               Style="{StaticResource TitleTextBlockStyle}"
               Margin="24,8,0,24" />

    <ScrollView Grid.Row="1"
                ContentOrientation="Vertical">
      <StackPanel Padding="24,0,24,40"
                  Spacing="12">

        <toolkit:SettingsCard Header="실행 상태"
                              HeaderIcon="More"
                              Description="상세 설정을 변경하려면 실행 상태를 끔으로 변경하세요.">
          <ToggleSwitch x:Name="View_ChekckServiceToggleSwitch"
                        IsOn="{x:Bind ViewModel.Settings.IsKeepAlivePlayerActive, Mode=TwoWay}"
                        OnContent="Running"
                        OffContent="Stopped" />
        </toolkit:SettingsCard>

        <StackPanel>
          <toolkit:SettingsCard Header="시작 시 실행"
                                HeaderIcon="Play"
                                Description="시작 앱에 등록하여 시작 시 자동으로 실행합니다.">
            <ToggleSwitch x:Name="View_StartupTaskToggleSwitch"
                          Toggled="View_StartupTaskToggleSwitch_Toggled" />
          </toolkit:SettingsCard>
          <InfoBar x:Name="View_StartupTaskInfoBar"
                   IsOpen="True"
                   Severity="Warning"
                   Title="시작 앱 등록이 사용자에 의해 해제되었습니다."
                   Message="앱 설정의 [로그인하여 실행]에서 시작 상태를 직접 변경하세요."
                   IsClosable="False"
                   Visibility="Collapsed"
                   CornerRadius="0,0,4,4"
                   BorderThickness="1,0,1,1"
                   Canvas.ZIndex="-1">
            <InfoBar.ActionButton>
              <Button x:Name="View_ViewStartupTaskSettingsButton"
                      Content="앱 설정 열기"
                      HorizontalAlignment="Right"
                      Click="View_ViewStartupTaskSettingsButton_Click" />
            </InfoBar.ActionButton>
          </InfoBar>
        </StackPanel>

        <toolkit:SettingsExpander Header="선택한 블루투스 기기만 연결 유지"
                                  HeaderIcon="Accept"
                                  Description="옵션을 끄면 실행 중일 때 항상 연결 유지 신호를 보냅니다."
                                  IsExpanded="{x:Bind ViewModel.Settings.ApplyToSelectedDevices, Mode=OneWay}"
                                  ItemsSource="{x:Bind ViewModel.UserDevices}">
          <ToggleSwitch IsOn="{x:Bind ViewModel.Settings.ApplyToSelectedDevices, Mode=TwoWay}"
                        IsEnabled="{x:Bind ViewModel.NegateBool(ViewModel.Settings.IsKeepAlivePlayerActive), Mode=OneWay}" />

          <toolkit:SettingsExpander.ItemTemplate>
            <DataTemplate x:DataType="local:UserDevice">
              <toolkit:SettingsCard HeaderIcon="Audio"
                                    Header="{x:Bind BluetoothDevice.Name}"
                                    IsEnabled="{x:Bind IsEnabled, Mode=OneWay}">
                <ToggleSwitch IsOn="{x:Bind IsSelected, Mode=TwoWay}"
                              IsEnabled="{x:Bind IsEditable, Mode=OneWay}" />
                <toolkit:SettingsCard.Description>
                  <StackPanel Orientation="Horizontal"
                              Spacing="12">
                    <TextBlock Text="{x:Bind IsConnected, Mode=OneWay}" />

                    <TextBlock Text="{x:Bind BluetoothDevice.HostName}"
                               Width="120" />
                  </StackPanel>
                </toolkit:SettingsCard.Description>
              </toolkit:SettingsCard>
            </DataTemplate>
          </toolkit:SettingsExpander.ItemTemplate>
        </toolkit:SettingsExpander>

        <toolkit:SettingsCard Header="반복 주기"
                              HeaderIcon="Sync"
                              Description="오디오를 반복할 시간">
          <controls:DurationPicker Duration="{x:Bind ViewModel.Settings.KeepAliveInterval, Mode=TwoWay}"
                                   IsEnabled="{x:Bind ViewModel.NegateBool(ViewModel.Settings.IsKeepAlivePlayerActive), Mode=OneWay}" />
        </toolkit:SettingsCard>

        <toolkit:SettingsCard Header="오디오 선택"
                              HeaderIcon="Volume"
                              Description="오디오">
          <StackPanel Orientation="Horizontal"
                      Spacing="8">
            <ComboBox x:Name="View_SoundTestComboBox"
                      SelectedIndex="{x:Bind ViewModel.Settings.SoundKind, Converter={StaticResource SoundKindToIntConverter}, Mode=TwoWay}"
                      IsEnabled="{x:Bind ViewModel.NegateBool(ViewModel.Settings.IsKeepAlivePlayerActive), Mode=OneWay}">
              <ComboBoxItem Content="Silent (1-second)" />
              <ComboBoxItem Content="Silent (5-second)" />
              <ComboBoxItem Content="Beep 1" />
              <ComboBoxItem Content="Beep 2" />
              <ComboBoxItem Content="Beep 3" />
              <ComboBoxItem Content="Beep 4" />
            </ComboBox>

            <Button Command="{x:Bind ViewModel.PlayTestSoundButtonClickCommand}"
                    CommandParameter="{x:Bind View_SoundTestComboBox.SelectedIndex, Mode=OneWay}"
                    Padding="8,6">
              <FontIcon Glyph="&#xE768;"
                        FontSize="16" />
            </Button>
            <Button Command="{x:Bind ViewModel.StopTestSoundButtonClickCommand}"
                    Padding="8,6">
              <FontIcon Glyph="&#xE769;"
                        FontSize="16" />
            </Button>
          </StackPanel>
        </toolkit:SettingsCard>

        <toolkit:SettingsCard Header="앱 종료"
                              HeaderIcon="Clear"
                              Description="백그라운드에서 실행되는 연결 유지 신호 재생을 포함한 앱의 모든 프로세스를 완전히 종료합니다.">
          <Button Content="End" 
                  Click="Button_Click"/>
        </toolkit:SettingsCard>
        
        <toolkit:SettingsExpander Header="Bluetooth Audio KeepAlive"
                                  Description="© 2025. ZeroFinchNeil. All rights reserved.">
          <toolkit:SettingsExpander.HeaderIcon>
            <ImageIcon Source="/Assets/BluetoothAudioKeepAlive_128.png" />
          </toolkit:SettingsExpander.HeaderIcon>

          <toolkit:SettingsExpander.Content>
            <TextBlock Text="v1.0.0.0"
                       Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
          </toolkit:SettingsExpander.Content>
          <toolkit:SettingsExpander.Items>
            <toolkit:SettingsCard ContentAlignment="Left">

              <TextBlock Text="Text" />
            </toolkit:SettingsCard>
          </toolkit:SettingsExpander.Items>
        </toolkit:SettingsExpander>
      </StackPanel>
    </ScrollView>
  </Grid>
</Page>
